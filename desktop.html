<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Avatar Overlay Innovation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    .mainAvatarFrame { width:100%; height:100%; position:fixed; top:0; left:0;z-index:9999999;}
    /* body {
      margin:0;
      font-family:Arial, sans-serif;
      height:200vh;
      background-image:url("../images/AUBG.png");
      background-size:contain;
      background-repeat:no-repeat;
      overflow:hidden;
    } */

    .page-content { padding:20px; }

    #overlay { position:fixed; inset:0; z-index:9999; pointer-events:none; }

    .overlay-panel {
      position:absolute;
      color:#fff;
      opacity:0;
      width:400px;
      height:150px;
      box-sizing:border-box;
      pointer-events:auto;
    }

    #panel4 {
      top:0;
      left:0;
      width:100%;
      height:100%;
      position: absolute;
    }

    #panel4.show {
      animation: expandToFull .5s forwards;
    }

    @keyframes expandToFull {
      0% { width:400px; height:150px; opacity:0; }
      10% { opacity:1; }
      100% {
        width:100%;
        height:100%;
        top:0;
        left:0;
        border-radius:0;
        opacity:1;
      }
    }

    /* First background video */
    .AVfire {
      position:absolute;
      top:0;
      left:0;
      z-index:1;
      width:100%;
      height:100%;
      overflow:hidden;
    }
    .AVfire video {
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    /* #overlayVideo2 { pointer-events:none; } */

    /* Second/trailer video */
    #overlayVideo {
      opacity:0;
      transition:opacity .1s ease;
      width:100%;
      height:100%;
      background:rgba(0,0,0,1);
      object-fit:cover;
      display:block;
      z-index:999;
    }

    #panel4.playing #overlayVideo {
      opacity:1;
      pointer-events:auto;
    }

    /* Skip / Close button – top-right */
    #closeOverlayBtn {
      display:none;
      position:absolute;
      top:20px;
      right:20px;
      background:rgba(255,255,255,.2);
      border:none;
      color:#fff;
      padding:6px 10px;
      font-size:20px;
      cursor:pointer;
      z-index:10000;
      backdrop-filter:blur(5px);
      border-radius:6px;
    }

    /* extra close button on trailer – top-left */
    #closeSecondBtn {
      display:none;
      position:absolute;
      top:20px;
      left:20px;
      z-index:10001;
      background:rgba(0,0,0,.45);
      color:#fff;
      border:none;
      padding:6px 10px;
      font-size:20px;
      cursor:pointer;
      border-radius:6px;
    }

    #overlayVideo, #closeOverlayBtn, #closeSecondBtn { z-index:9998; }

    @media (max-width:600px) {
      #closeOverlayBtn, #closeSecondBtn {
        font-size:16px;
        padding:6px 8px;
        top:12px;
      }
    }
    .overlay-panel.show.playing #AVfire{
      display: none;
    }
    .overlay-panel.show.playing #overlayVideo{
      height: auto;
    }
    .overlay-panel.show.playing:has(#overlayVideo){
      background-color: black;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="mainAvatarFrame" id="mainAvatarFrame">
    <div class="page-content"></div>
    <div id="overlay">
      <div id="panel4" class="overlay-panel">
        <div class="AVfire" id="AVfire">
          <video id="overlayVideo2" muted playsinline preload="auto" crossorigin="anonymous" aria-hidden="true"></video>
        </div>
        <video id="overlayVideo" controls autoplay muted playsinline preload="metadata"></video>
        <button id="closeOverlayBtn">Skip / Close ✕</button>
      </div>
    </div>
  </div>

<script>
(function () {
  const panel4 = document.getElementById('panel4');
  const overlay = document.getElementById('overlay');
  const mainAvatarFrame = document.getElementById('mainAvatarFrame');

  const firstVideo = document.getElementById('overlayVideo2'); // intro
  const secondVideo = document.getElementById('overlayVideo'); // trailer

  const closeBtn = document.getElementById('closeOverlayBtn');
  const closeSecondBtn = document.getElementById('closeSecondBtn');

  // --- SIMPLE CONFIG ---

  const MOV_SRC  = 'https://vid.amarujala.com/gam/bg22.mov';
  const WEBM_SRC = 'https://vid.amarujala.com/gam/bg203122025.webm';
  const TRAILER_MP4 = 'https://vid.amarujala.com/gam/avatarTrailer.mp4';

  const FIRST_START_DELAY_MS = 2000; // still keep 2s delay before first video starts

  // --- HELPERS ---

  function isSafari() {
const ua = navigator.userAgent;
      const vendor = navigator.vendor;

      // Check vendor first (Safari has "Apple Computer, Inc.")
      const isAppleVendor = /Apple Computer/.test(vendor);

      // Exclude all Chromium-based browsers
      const isChromium = /Chrome|Chromium|CriOS|EdgiOS|OPiOS/.test(ua);

      // Exclude Firefox
      const isFirefox = /Firefox|FxiOS/.test(ua);

      // Safari should have Safari in UA, AppleWebKit, Apple vendor, and NOT be Chromium or Firefox
      return isAppleVendor && /Safari/.test(ua) && !isChromium && !isFirefox;
  }

  function setSource(videoEl, src, type) {
    while (videoEl.firstChild) videoEl.removeChild(videoEl.firstChild);
    const s = document.createElement('source');
    s.src = src;
    if (type) s.type = type;
    videoEl.appendChild(s);
    try { videoEl.load(); } catch (e) {}
  }

  function endOverlay() {
    try { firstVideo.pause(); } catch(e) {}
    try { secondVideo.pause(); } catch(e) {}
    overlay.style.display = 'none';
    mainAvatarFrame.style.display = 'none';
  }

  // --- MAIN FLOW ---

  (function init() {
    // 1) Expand panel
    setTimeout(() => {
      panel4.classList.add('show');
      panel4.setAttribute('aria-hidden', 'false');
    }, 200);

    // 2) Set sources
    if (isSafari()) {
      // ✅ Safari → prefer .mov
      setSource(firstVideo, MOV_SRC, 'video/quicktime');
    } else {
      // ✅ Other browsers → prefer .webm
      setSource(firstVideo, WEBM_SRC, 'video/webm');
    }

    setSource(secondVideo, TRAILER_MP4, 'video/mp4');

    // 3) FIRST VIDEO: when loaded, wait 2s then play
    firstVideo.addEventListener('loadeddata', () => {
      setTimeout(() => {
        firstVideo.play().catch(err => {
          console.warn('First video autoplay failed:', err);
          // if it fails, you could optionally start second video here
        });
      }, FIRST_START_DELAY_MS);
    }, { once: true });

    // 4) When first video ENDS (last frame reached) → start second video
    firstVideo.addEventListener('ended', () => {
      // Show trailer area + buttons
      panel4.classList.add('playing');
      closeBtn.style.display = 'block';
      closeSecondBtn.style.display = 'block';

      secondVideo.play().catch(err => {
        console.warn('Second video autoplay failed:', err);
      });
    }, { once: true });

    // 5) When SECOND video ENDS (last frame) → close innovation
    secondVideo.addEventListener('ended', () => {
      endOverlay();
    }, { once: true });

    // 6) Close buttons
    closeBtn.addEventListener('click', endOverlay);
    closeSecondBtn.addEventListener('click', endOverlay);

    // ESC key also closes
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') endOverlay();
    });
  })();
})();
</script>
</body>
</html>
